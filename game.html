<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SkyBurst Game</title>
  <style>
    body {
      background-color: #111;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 800px;
      margin: 0 auto 20px auto;
    }

    #balance {
      font-size: 18px;
      color: #0f0;
    }

    .top-btn {
      background-color: #222;
      color: #0ff;
      padding: 6px 12px;
      margin-left: 5px;
      border: 1px solid #0ff;
      border-radius: 8px;
      cursor: pointer;
    }

    .game-area {
      display: flex;
      justify-content: center;
      max-width: 800px;
      margin: auto;
    }

    #gameCanvas {
      background-color: #222;
      border: 2px solid #555;
      margin-right: 30px;
    }

    .coin-btn {
      background: #0ff;
      color: #000;
      font-weight: bold;
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }

    #selected-amount {
      margin-top: 10px;
      color: #0f0;
    }

    .action-btns button {
      padding: 10px 30px;
      margin: 10px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }

    #cash-in {
      background-color: green;
      color: white;
    }

    #cash-out {
      background-color: orange;
      color: black;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div id="balance">üí∞ Balance: Loading...</div>
    <div>
      <button class="top-btn" id="referral-btn">üéÅ Referral</button>
      <button class="top-btn" id="recharge-btn">‚ö° Recharge</button>
      <button class="top-btn" id="withdraw-btn">üí∏ Withdraw</button>
      <button class="top-btn" onclick="resetSelected()">üîÑ Reset Coins</button>
    </div>
  </div>

  <div class="game-area">
    <canvas id="gameCanvas" width="400" height="500"></canvas>
    <div>
      <h3>Select Coins</h3>
      <div>
        <button class="coin-btn" data-value="10">10</button>
        <button class="coin-btn" data-value="20">20</button>
        <button class="coin-btn" data-value="50">50</button>
        <button class="coin-btn" data-value="100">100</button>
        <button class="coin-btn" data-value="500">500</button>
      </div>

      <div id="selected-amount">Selected: 0 coins</div>
      <div class="action-btns">
        <button id="cash-in">üöÄ Cash In</button>
        <button id="cash-out">ü™Ç Cash Out</button>
      </div>
    </div>
  </div>

  <script>
  window.onload = () => {
    const SUPABASE_URL = "https://omcaquhsmeqfhxpusawu.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tY2FxdWhzbWVxZmh4cHVzYXd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyMTE2ODIsImV4cCI6MjA2ODc4NzY4Mn0.efl5MQ-lbY6kkeMujJQ8NDTLdc_7r_bkTj_AZzwcj4Y";
    const adminPhone = "0797416633";
    const telegramBotToken = "7859896649:AAE4xWMYhE1wsSVqpbBNUC6MXYA2zqGvgdA";
    const adminTelegramChatID = "6825228721";

    let userPhone = localStorage.getItem("userPhone");
    if (!userPhone) {
      alert("‚ö† Please login first.");
      window.location.href = "register.html";
      return;
    }

    let selectedAmount = 0;
    let userBalance = 0;

    async function fetchBalance() {
      const res = await fetch(${SUPABASE_URL}/rest/v1/skyburst_users?phone=eq.${userPhone}, {
        headers: {
          apikey: SUPABASE_KEY,
          Authorization: Bearer ${SUPABASE_KEY},
        }
      });
      const data = await res.json();
      if (data.length > 0) {
        userBalance = data[0].coins;
        document.getElementById("balance").innerText = üí∞ Balance: ${userBalance} coins;
      }
    }

    async function updateBalance(newBalance) {
      await fetch(${SUPABASE_URL}/rest/v1/skyburst_users?phone=eq.${userPhone}, {
        method: "PATCH",
        headers: {
          apikey: SUPABASE_KEY,
          Authorization: Bearer ${SUPABASE_KEY},
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ coins: newBalance })
      });
      userBalance = newBalance;
      document.getElementById("balance").innerText = üí∞ Balance: ${userBalance} coins;
    }

    function resetSelected() {
      selectedAmount = 0;
      document.getElementById("selected-amount").innerText = Selected: 0 coins;
    }

    document.querySelectorAll(".coin-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const value = parseInt(btn.getAttribute("data-value"));
        selectedAmount += value;
        document.getElementById("selected-amount").innerText = Selected: ${selectedAmount} coins;
      });
    });

    document.getElementById("cash-in").addEventListener("click", async () => {
      if (selectedAmount <= 0) return alert("‚ö† Select an amount first.");
      if (userBalance < selectedAmount) return alert("‚ùå Not enough balance.");
      userBalance -= selectedAmount;
      await updateBalance(userBalance);
      startFlight();
    });

    document.getElementById("cash-out").addEventListener("click", async () => {
      if (!canCashOut || exploded) return alert("‚ùå You can‚Äôt cash out now.");
      const earned = selectedAmount * 2;
      userBalance += earned;
      await updateBalance(userBalance);
      alert(ü™Ç You cashed out and earned ${earned} coins);
      resetFlight();
    });

    document.getElementById("referral-btn").addEventListener("click", () => {
      const link = ${window.location.origin}/register.html?ref=${userPhone};
      navigator.clipboard.writeText(link).then(() => {
        alert("üéÅ Referral link copied to clipboard!");
      });
    });

    document.getElementById("recharge-btn").addEventListener("click", () => {
      alert(‚ö° Send money to: ${adminPhone} then wait for approval.);
      fetch(https://api.telegram.org/bot${telegramBotToken}/sendMessage, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          chat_id: adminTelegramChatID,
          text: üí∞ Recharge requested by ${userPhone}. Sent to ${adminPhone}
        })
      });
    });

    document.getElementById("withdraw-btn").addEventListener("click", () => {
      const amount = prompt("Enter amount to withdraw:");
      if (!amount || isNaN(amount)) return alert("‚ùå Invalid amount.");
      const number = prompt("Enter M-PESA number:");
      if (!number) return alert("‚ùå Invalid number.");
      alert(üí∏ Withdrawal request of ${amount} KES sent.);
      fetch(https://api.telegram.org/bot${telegramBotToken}/sendMessage, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          chat_id: adminTelegramChatID,
          text: üì§ Withdrawal request:\nUser: ${userPhone}\nAmount: ${amount} KES\nM-PESA: ${number}
        })
      });
    });

    // === GAME LOGIC ===
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    let shipY = 400;
    let speed = 1;
    let flying = false;
    let exploded = false;
    let canCashOut = false;

    function drawShip() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (flying && !exploded) {
        ctx.fillStyle = "#fff";
        ctx.fillRect(160, shipY, 20, 40);

        ctx.fillStyle = "#f90";
        ctx.beginPath();
        ctx.moveTo(160, shipY + 40);
        ctx.lineTo(170, shipY + 60);
        ctx.lineTo(180, shipY + 40);
        ctx.fill();
      }

      if (exploded) {
        ctx.fillStyle = "red";
        ctx.beginPath();
        ctx.arc(170, shipY + 20, 30, 0, Math.PI * 2);
        ctx.fill();
      }

      if (!flying && canCashOut) drawParachute();
    }

    function drawParachute() {
      ctx.fillStyle = "yellow";
      ctx.beginPath();
      ctx.arc(170, shipY, 15, 0, Math.PI, true);
      ctx.fill();
      ctx.fillStyle = "#000";
      ctx.fillRect(165, shipY, 10, 20);
    }

    function animateShip() {
      if (!flying || exploded) return;
      shipY -= speed;
      speed += 0.2;
      drawShip();

      if (Math.random() < 0.005) {
        exploded = true;
        drawShip();
        alert("üí• The ship exploded!");
        resetFlight();
      } else {
        requestAnimationFrame(animateShip);
      }
    }

    function startFlight() {
      flying = true;
      canCashOut = false;
      animateShip();
      setTimeout(() => {
        if (!exploded) canCashOut = true;
      }, 3000);
    }

    function resetFlight() {
      shipY = 400;
      speed = 1;
      flying = false;
      canCashOut = false;
      exploded = false;
      selectedAmount = 0;
      document.getElementById("selected-amount").innerText = Selected: 0 coins;
      drawShip();
    }

    drawShip();
    fetchBalance();
  };
  </script>
</body>
</html>
