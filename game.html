<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SkyBurst Game</title>
  <style>
    body {
      background-color: #111;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 800px;
      margin: 0 auto 20px auto;
    }

    #balance {
      font-size: 20px;
      color: #0f0;
    }

    .top-btn {
      background-color: #333;
      color: #0ff;
      padding: 6px 14px;
      margin-left: 5px;
      border: 1px solid #0ff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s ease;
    }

    .top-btn:hover {
      background-color: #0ff;
      color: #000;
    }

    .game-area {
      display: flex;
      justify-content: center;
      max-width: 800px;
      margin: auto;
    }

    #gameCanvas {
      background-color: #222;
      border: 2px solid #555;
      margin-right: 30px;
    }

    .coin-selection {
      margin-bottom: 20px;
    }

    .coin-btn {
      background: #0ff;
      color: #000;
      font-weight: bold;
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }

    .action-btns {
      margin-top: 10px;
    }

    .action-btns button {
      padding: 10px 30px;
      margin: 10px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }

    #cash-in {
      background-color: green;
      color: white;
    }

    #cash-out {
      background-color: orange;
      color: black;
    }

    #selected-amount {
      font-size: 18px;
      color: #0f0;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div id="balance">üí∞ Balance: 0 coins</div>
    <div>
      <button class="top-btn" id="referral-btn">üéÅ Referral</button>
      <button class="top-btn" id="recharge-btn">‚ö° Recharge</button>
      <button class="top-btn" id="withdraw-btn">üí∏ Withdraw</button>
    </div>
  </div>

  <div class="game-area">
    <canvas id="gameCanvas" width="400" height="500"></canvas>
    <div>
      <h2>Select Coin Amount</h2>
      <div class="coin-selection">
        <button class="coin-btn" data-value="10">10</button>
        <button class="coin-btn" data-value="20">20</button>
        <button class="coin-btn" data-value="50">50</button>
        <button class="coin-btn" data-value="100">100</button>
      </div>

      <div id="selected-amount">Selected: 0 coins</div>
      <div class="action-btns">
        <button id="cash-in">üöÄ Cash In</button>
        <button id="cash-out">ü™Ç Cash Out</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const adminPhone = "0797416633";
    const telegramBotToken = "7859896649:AAE4xWMYhE1wsSVqpbBNUC6MXYA2zqGvgdA";
    const adminTelegramChatID = "6825228721";

    const SUPABASE_URL = "https://fdlspkbeelghpyvmvkyg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tY2FxdWhzbWVxZmh4cHVzYXd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyMTE2ODIsImV4cCI6MjA2ODc4NzY4Mn0.efl5MQ-lbY6kkeMujJQ8NDTLdc_7r_bkTj_AZzwcj4Y";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let shipY = 400;
    let speed = 1;
    let flying = false;
    let exploded = false;
    let canCashOut = false;
    let selectedAmount = 0;
    let userPhone = localStorage.getItem("userPhone") || "Unknown";
    let userBalance = 0;

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    async function getUserBalance() {
      const { data } = await supabase
        .from("skyburst_users")
        .select("coins")
        .eq("phone", userPhone)
        .single();

      if (data) {
        userBalance = data.coins;
        updateBalanceDisplay();
      }
    }

    async function updateUserBalance(newBalance) {
      userBalance = newBalance;
      updateBalanceDisplay();

      await supabase
        .from("skyburst_users")
        .update({ coins: newBalance })
        .eq("phone", userPhone);
    }

    function updateBalanceDisplay() {
      document.getElementById("balance").innerText = üí∞ Balance: ${userBalance} coins;
    }

    function drawShip() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (flying && !exploded) {
        ctx.fillStyle = "#fff";
        ctx.fillRect(160, shipY, 20, 40);
        ctx.fillStyle = "#f90";
        ctx.beginPath();
        ctx.moveTo(160, shipY + 40);
        ctx.lineTo(170, shipY + 60);
        ctx.lineTo(180, shipY + 40);
        ctx.fill();
      }

      if (exploded) {
        ctx.fillStyle = "red";
        ctx.beginPath();
        ctx.arc(170, shipY + 20, 30, 0, Math.PI * 2);
        ctx.fill();
      }

      if (!flying && canCashOut) drawParachute();
    }

    function animateShip() {
      if (!flying || exploded) return;

      shipY -= speed;
      speed += 0.2;
      drawShip();

      if (Math.random() < 0.005) {
        exploded = true;
        drawShip();
        alert("üí• The ship exploded!");
        resetFlight();
      } else {
        requestAnimationFrame(animateShip);
      }
    }

    function drawParachute() {
      ctx.fillStyle = "yellow";
      ctx.beginPath();
      ctx.arc(170, shipY, 15, 0, Math.PI, true);
      ctx.fill();
      ctx.fillStyle = "#000";
      ctx.fillRect(165, shipY, 10, 20);
    }

    function resetFlight() {
      shipY = 400;
      speed = 1;
      flying = false;
      canCashOut = false;
      exploded = false;
      selectedAmount = 0;
      updateSelectedDisplay();
    }

    function updateSelectedDisplay() {
      document.getElementById("selected-amount").innerText = Selected: ${selectedAmount} coins;
    }

    document.querySelectorAll(".coin-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        selectedAmount = parseInt(btn.getAttribute("data-value"));
        updateSelectedDisplay();
      });
    });

    document.getElementById("cash-in").addEventListener("click", async () => {
      if (flying || selectedAmount <= 0 || selectedAmount > userBalance) return;

      flying = true;
      canCashOut = false;
      await updateUserBalance(userBalance - selectedAmount);
      animateShip();

      setTimeout(() => {
        if (!exploded) canCashOut = true;
      }, 3000);
    });

    document.getElementById("cash-out").addEventListener("click", async () => {
      if (!canCashOut || exploded) return;

      const winnings = selectedAmount * 2;
      await updateUserBalance(userBalance + winnings);
      flying = false;
      drawParachute();
      alert(ü™Ç You cashed out and earned ${winnings} coins);
      resetFlight();
    });

    // üéÅ Referral
    document.getElementById("referral-btn").addEventListener("click", () => {
      const link = ${window.location.origin}/register.html?ref=${userPhone};
      navigator.clipboard.writeText(link).then(() => {
        alert(üéÅ Referral link copied:\n${link});
      });
    });

    // ‚ö° Recharge
    document.getElementById("recharge-btn").addEventListener("click", () => {
      alert(‚ö° Send money to: ${adminPhone}\nThen wait for admin approval.);

      fetch(https://api.telegram.org/bot${telegramBotToken}/sendMessage, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          chat_id: adminTelegramChatID,
          text: üí∞ Recharge Prompted\nUser: ${userPhone}\nAsked to pay: ${adminPhone}
        })
      });
    });

    // üí∏ Withdraw
    document.getElementById("withdraw-btn").addEventListener("click", async () => {
      const amount = prompt("Enter amount to withdraw:");
      if (!amount || isNaN(amount)) return;

      const mpesa = prompt("Enter M-PESA number:");
      if (!mpesa) return;

      await supabase
        .from("withdrawals")
        .insert([{ phone: userPhone, amount: parseInt(amount), mpesa, status: "pending" }]);

      alert("‚úÖ Withdrawal request sent. Admin will approve shortly.");
    });

    getUserBalance().then(() => drawShip());
  </script>
</body>
</html>
